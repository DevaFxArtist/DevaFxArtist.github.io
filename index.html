<script>

let pageData = {
  hero: {
    name: "Deva Bhuvaneswaran",
    about: "FX Artist | Procedural FX",
    profileImage: ""
  },
  links: []
};

let editMode = false;
let draggingEl = null;
let floatingEl = null;
let editingId = null;

function generateId(){
  return Math.random().toString(36).substr(2,9);
}

async function loadGrid(){
  const res = await fetch("data.json");
  const raw = await res.json();

  pageData.links = raw.map(card => ({
    ...card,
    id: generateId()
  }));

  renderAll();
}

function renderAll(){
  renderHero();
  renderLinks();
}

function renderHero(){
  const hero = document.querySelector(".hero");

  hero.innerHTML = `
    <h1 ondblclick="enableHeroEdit(this,'name')">
      ${pageData.hero.name}
    </h1>
    <p ondblclick="enableHeroEdit(this,'about')">
      ${pageData.hero.about}
    </p>
  `;
}

function enableHeroEdit(el, field){
  if(!editMode) return;

  el.contentEditable = true;
  el.focus();

  el.onblur = () => {
    pageData.hero[field] = el.innerText;
    el.contentEditable = false;
  };
}

function renderLinks(){
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  pageData.links.forEach(card => {

    const div = document.createElement("div");
    div.className = "card";
    div.dataset.id = card.id;

    if(card.size === "large")
      div.classList.add("large");

    div.innerHTML = `
      <span ondblclick="enableEdit(this,'${card.id}')">
        ${card.title}
      </span>

      <div class="edit-controls">
        <button class="icon-btn"
          onclick="event.stopPropagation(); openLinkModal('${card.id}')">
          ğŸ”—
        </button>

        <button class="icon-btn"
          onclick="event.stopPropagation(); toggleSize('${card.id}')">
          â¬›
        </button>

        <button class="icon-btn"
          onclick="event.stopPropagation(); deleteCard('${card.id}')">
          ğŸ—‘
        </button>
      </div>
    `;

    if(!editMode){
      div.onclick = () => {
        if(card.link && card.link !== "#"){
          window.open(card.link, "_blank", "noopener");
        }
      };
    }

    if(editMode){
      div.onmousedown = (e) => startDrag(e, div);
    }

    grid.appendChild(div);
  });

  if(editMode){
    const add = document.createElement("div");
    add.className = "card add-card";
    add.innerHTML = "+";
    add.onclick = addCard;
    grid.appendChild(add);
  }
}

function enableEdit(el, id){
  if(!editMode) return;

  el.contentEditable = true;
  el.focus();

  el.onblur = () => {
    const card = pageData.links.find(c => c.id === id);
    card.title = el.innerText;
    el.contentEditable = false;
  };
}

function deleteCard(id){
  pageData.links =
    pageData.links.filter(c => c.id !== id);
  renderLinks();
}

function addCard(){
  pageData.links.push({
    id: generateId(),
    title: "New Card",
    link: "#",
    size: "normal"
  });
  renderLinks();
}

function toggleSize(id){
  const card =
    pageData.links.find(c => c.id === id);

  card.size =
    card.size === "large" ? "normal" : "large";

  renderLinks();
}

function openLinkModal(id){
  editingId = id;

  document.getElementById("linkInput").value =
    pageData.links.find(c => c.id === id).link;

  document.getElementById("linkModal").style.display = "flex";
}

function saveLink(){
  pageData.links.find(c => c.id === editingId).link =
    document.getElementById("linkInput").value;

  document.getElementById("linkModal").style.display = "none";
}

function startDrag(e, element){
  draggingEl = element;

  floatingEl = element.cloneNode(true);
  floatingEl.classList.add("floating");
  floatingEl.style.width =
    element.offsetWidth + "px";
  floatingEl.style.height =
    element.offsetHeight + "px";

  floatingEl.querySelector(".edit-controls")?.remove();

  document.body.appendChild(floatingEl);

  element.classList.add("drag-placeholder");

  moveFloating(e);

  document.addEventListener("mousemove", moveDrag);
  document.addEventListener("mouseup", endDrag);
}

function moveFloating(e){
  floatingEl.style.left =
    e.clientX - (floatingEl.offsetWidth / 2) + "px";

  floatingEl.style.top =
    e.clientY - (floatingEl.offsetHeight / 2) + "px";
}

function moveDrag(e){
  moveFloating(e);

  const elements = [
    ...document.querySelectorAll(
      ".grid .card:not(.drag-placeholder)"
    )
  ];

  for(const el of elements){

    const rect = el.getBoundingClientRect();

    if(
      e.clientX > rect.left &&
      e.clientX < rect.right &&
      e.clientY > rect.top &&
      e.clientY < rect.bottom
    ){
      if(el !== draggingEl){
        el.parentNode.insertBefore(draggingEl, el);
      }
      break;
    }
  }
}

function endDrag(){
  draggingEl.classList.remove("drag-placeholder");

  floatingEl.remove();

  updateArrayFromDOM();

  document.removeEventListener("mousemove", moveDrag);
  document.removeEventListener("mouseup", endDrag);
}

function updateArrayFromDOM(){
  const domCards = [
    ...document.querySelectorAll(
      ".grid .card:not(.add-card)"
    )
  ];

  pageData.links = domCards.map(el =>
    pageData.links.find(
      c => c.id === el.dataset.id
    )
  );
}

function handleToggle(){
  editMode = !editMode;

  const btn =
    document.getElementById("toggleBtn");

  if(editMode){
    document.body.classList.add("edit-mode");
    btn.innerText = "ğŸ’¾ Save Changes";
    btn.classList.add("save-mode");
  } else {
    document.body.classList.remove("edit-mode");
    btn.innerText = "âœ Edit Mode";
    btn.classList.remove("save-mode");
  }

  renderAll();
}

loadGrid();

</script>
