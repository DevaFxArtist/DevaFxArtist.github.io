<script>
let cards=[];
let editMode=false;
let draggingEl=null;
let floatingEl=null;
let editingId=null;
let lastSwapTime=0; // anti-jitter cooldown

function generateId(){
return Math.random().toString(36).substr(2,9);
}

async function loadGrid(){
const res=await fetch("data.json");
const raw=await res.json();
cards=raw.map(card=>({...card,id:generateId()}));
renderGrid();
}

function renderGrid(){
const grid=document.getElementById("grid");
grid.innerHTML="";

cards.forEach(card=>{
const div=document.createElement("div");
div.className="card";
div.dataset.id=card.id;
if(card.size==="large") div.classList.add("large");

div.innerHTML=`
<span ondblclick="enableEdit(this,'${card.id}')">${card.title}</span>
<div class="edit-controls">
<button class="icon-btn" onclick="event.stopPropagation(); openLinkModal('${card.id}')">üîó</button>
<button class="icon-btn" onclick="event.stopPropagation(); toggleSize('${card.id}')">‚¨õ</button>
<button class="icon-btn" onclick="event.stopPropagation(); deleteCard('${card.id}')">üóë</button>
</div>
`;

if(!editMode){
div.onclick=()=>window.open(card.link,"_blank");
}

if(editMode){
div.onmousedown=(e)=>startDrag(e,div);
}

grid.appendChild(div);
});

if(editMode){
const add=document.createElement("div");
add.className="card add-card";
add.innerHTML="+";
add.onclick=addCard;
grid.appendChild(add);
}
}

function enableEdit(el,id){
if(!editMode) return;
el.contentEditable=true;
el.focus();
el.onblur=()=>{
const card=cards.find(c=>c.id===id);
card.title=el.innerText;
el.contentEditable=false;
};
}

function deleteCard(id){
cards=cards.filter(c=>c.id!==id);
renderGrid();
}

function addCard(){
cards.push({id:generateId(),title:"New Card",link:"#",size:"normal"});
renderGrid();
}

function toggleSize(id){
const card=cards.find(c=>c.id===id);
card.size=card.size==="large"?"normal":"large";
renderGrid();
}

function openLinkModal(id){
editingId=id;
document.getElementById("linkInput").value=
cards.find(c=>c.id===id).link;
document.getElementById("linkModal").style.display="flex";
}

function saveLink(){
cards.find(c=>c.id===editingId).link=
document.getElementById("linkInput").value;
document.getElementById("linkModal").style.display="none";
}

/* ============================= */
/* ======== DRAG ENGINE ======== */
/* ============================= */

function startDrag(e,element){

draggingEl=element;

floatingEl=element.cloneNode(true);
floatingEl.classList.add("floating");
floatingEl.style.width=element.offsetWidth+"px";
floatingEl.style.height=element.offsetHeight+"px";
floatingEl.querySelector(".edit-controls")?.remove();
document.body.appendChild(floatingEl);

element.classList.add("drag-placeholder");

moveFloating(e);

document.addEventListener("mousemove",moveDrag);
document.addEventListener("mouseup",endDrag);
}

function moveFloating(e){
floatingEl.style.left=e.clientX-(floatingEl.offsetWidth/2)+"px";
floatingEl.style.top=e.clientY-(floatingEl.offsetHeight/2)+"px";
}

function moveDrag(e){

moveFloating(e);

const elements=[...document.querySelectorAll(".grid .card:not(.drag-placeholder):not(.add-card)")];

let closest=null;
let closestDistance=Infinity;

for(const el of elements){

if(el===draggingEl) continue;

const rect=el.getBoundingClientRect();
const centerX=rect.left+rect.width/2;
const centerY=rect.top+rect.height/2;

const dx=e.clientX-centerX;
const dy=e.clientY-centerY;

const distance=Math.sqrt(dx*dx+dy*dy);

if(distance<closestDistance){
closestDistance=distance;
closest=el;
}
}

if(!closest) return;

/* threshold based on target size */
const threshold=closest.offsetHeight*0.4;
const now=Date.now();

/* cooldown prevents oscillation jitter */
if(closestDistance<threshold && now-lastSwapTime>120){

lastSwapTime=now;

/* --- FLIP: capture first positions --- */
const beforeRects={};
elements.forEach(el=>{
beforeRects[el.dataset.id]=el.getBoundingClientRect();
});

/* --- perform swap --- */
const parent=closest.parentNode;
const draggingIndex=[...parent.children].indexOf(draggingEl);
const closestIndex=[...parent.children].indexOf(closest);

if(draggingIndex<closestIndex){
parent.insertBefore(draggingEl,closest.nextSibling);
}else{
parent.insertBefore(draggingEl,closest);
}

/* --- FLIP animation --- */
animateFLIP(beforeRects);
}
}

function animateFLIP(beforeRects){

const cardsDOM=[...document.querySelectorAll(".grid .card:not(.add-card)")];

cardsDOM.forEach(card=>{
const first=beforeRects[card.dataset.id];
const last=card.getBoundingClientRect();

if(!first) return;

const dx=first.left-last.left;
const dy=first.top-last.top;

if(dx||dy){
card.style.transition="none";
card.style.transform=`translate(${dx}px,${dy}px)`;

requestAnimationFrame(()=>{
card.style.transition="transform 250ms cubic-bezier(.2,.8,.2,1)";
card.style.transform="";
});
}
});
}

function endDrag(){

draggingEl.classList.remove("drag-placeholder");
floatingEl.remove();

updateArrayFromDOM();

document.removeEventListener("mousemove",moveDrag);
document.removeEventListener("mouseup",endDrag);
}

function updateArrayFromDOM(){
const domCards=[...document.querySelectorAll(".grid .card:not(.add-card)")];
cards=domCards.map(el=>{
return cards.find(c=>c.id===el.dataset.id);
});
}

/* ============================= */

function handleToggle(){
editMode=!editMode;
const btn=document.getElementById("toggleBtn");

if(editMode){
document.body.classList.add("edit-mode");
btn.innerText="üíæ Save Changes";
btn.classList.add("save-mode");
}else{
document.body.classList.remove("edit-mode");
btn.innerText="‚úè Edit Mode";
btn.classList.remove("save-mode");
}

renderGrid();
}

loadGrid();
</script>
